#!/bin/sh
# postrm script for joomla
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postrm> `remove'
#        * <postrm> `purge'
#        * <old-postrm> `upgrade' <new-version>
#        * <new-postrm> `failed-upgrade' <old-version>
#        * <new-postrm> `abort-install'
#        * <new-postrm> `abort-install' <old-version>
#        * <new-postrm> `abort-upgrade' <old-version>
#        * <disappearer's-postrm> `disappear' <overwriter>
#          <overwriter-version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

INSTALLDIR=/var/www

fatal() {
	echo "ERROR: $1"
	[ -f /tmp/joomla-$$.tar.gz ] && rm -f /tmp/joomla-$$.tar.gz
	exit 1
}

upgrade_joomla() {
	VERSION=$1
	MIRROR=http://www.tuxis.nl/uploads/tmp
	[ -x /usr/bin/wget ] && wget -O /tmp/joomla-$$.tar.gz ${MIRROR}/joomla-${VERSION}.tar.gz
        [ -f /tmp/joomla-$$.tar.gz ] || /usr/bin/curl -s -o /tmp/joomla-$$.tar.gz ${MIRROR}/joomla-${VERSION}.tar.gz
	if [ $? -eq 0 ]; then
		cd ${INSTALLDIR} || fatal "Unable to go into directory ${INSTALLDIR}"
		tar zxf /tmp/joomla-$$.tar.gz || fatal "Unable to extract Joomla package into ${INSTALLDIR}"
	fi
	echo "Fixing permissions on /var/www"
	chown -R www-data:www-data /var/www
	chmod 640 ${INSTALLDIR}/configuration.php
	rm -rf ${INSTALLDIR}/installation/
	rm -f /tmp/joomla-$$.tar.gz
}

case "$1" in
    upgrade)
	NEW_VERSION=`echo $2 | cut -f 1 -d -`
	VERS_CHECK=`/usr/bin/openapp-joomla-detect ${INSTALLDIR} ${NEW_VERSION}`
        case "${VERS_CHECK}" in
		upgrade)
			echo "This version is newer, we should upgrade"
			upgrade_joomla ${NEW_VERSION}
		;;
		same|downgrade)
			echo "This version is the same or older, do nothing"
		;;
	esac
    ;;
    purge|remove|failed-upgrade|abort-install|abort-upgrade|disappear)
    ;;

    *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
